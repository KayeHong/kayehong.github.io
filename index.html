import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.background
import androidx.compose.foundation.gestures.detectDragGestures
import androidx.compose.foundation.layout.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.unit.IntOffset
import androidx.compose.ui.unit.dp
import kotlin.math.roundToInt

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            var offsetX by remember { mutableStateOf(0f) }
            var offsetY by remember { mutableStateOf(0f) }
            val iconSize = 80.dp
            val iconHalfSizePx = with(LocalDensity.current) { (iconSize / 2).toPx() }

            // 두 영역의 바운딩 박스 정의
            val firstAreaBounds = remember { mutableStateOf(Rect(0f, 0f, 400f, 400f)) }
            val secondAreaBounds = remember { mutableStateOf(Rect(400f, 0f, 800f, 400f)) }

            var inSecondArea by remember { mutableStateOf(false) }

            // 드래그 제스처 감지 및 위치 업데이트
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(Color.LightGray)
                    .pointerInput(Unit) {
                        detectDragGestures(
                            onDragStart = {
                                inSecondArea = false
                            },
                            onDragEnd = {
                                // 드래그가 끝났을 때 아이콘의 중앙이 두 번째 영역 안에 있는지 확인
                                val iconCenterX = offsetX + iconHalfSizePx
                                val iconCenterY = offsetY + iconHalfSizePx
                                if (iconCenterX > secondAreaBounds.value.left &&
                                    iconCenterX < secondAreaBounds.value.right &&
                                    iconCenterY > secondAreaBounds.value.top &&
                                    iconCenterY < secondAreaBounds.value.bottom) {
                                    inSecondArea = true
                                }
                            },
                            onDrag = { change, dragAmount ->
                                change.consume()
                                offsetX += dragAmount.x
                                offsetY += dragAmount.y
                            }
                        )
                    }
            ) {
                // 첫 번째 영역
                Box(
                    modifier = Modifier
                        .offset { IntOffset(0, 0) }
                        .size(400.dp)
                        .background(Color.Blue)
                )

                // 두 번째 영역
                Box(
                    modifier = Modifier
                        .offset { IntOffset(400, 0) }
                        .size(400.dp)
                        .background(Color.Green)
                )

                // 드래그 가능한 아이콘
                Box(
                    modifier = Modifier
                        .offset { IntOffset(offsetX.roundToInt(), offsetY.roundToInt()) }
                        .size(iconSize)
                        .background(Color.Red)
                )

                // 아이콘이 두 번째 영역에 완전히 들어갔을 때 알림
                if (inSecondArea) {
                    Text(
                        text = "Icon is in the second area",
                        modifier = Modifier
                            .align(Alignment.BottomCenter)
                            .padding(16.dp)
                            .background(Color.Black)
                            .padding(8.dp)
                            .background(Color.Yellow)
                    )
                }
            }
        }
    }
}
